#!/bin/bash
# Author: Percio Andrade
# Desc: Simple script to curl IP info
# Version: 1.0
# RECEIVE IP NUMBER
# 1.1
# SED CORRECTION AND GOOGLE URL CORRECTION
# 1.2
# GOOGLE JSON TO GET CEP AND ANDRESS

# CHECK IF CURL EXIST
if [[ ! -f "/usr/bin/curl" ]] || [[ ! -f "/usr/bin/dig" ]];then
        echo -e "\nInstalling dependencies\n"
        yum -y install curl dig
        clear
fi

IP=$1

# CHECK VALUES
if [[ -z ${IP} ]];then
echo -e "Please enter IP or domain to check"
exit

elif [[ $IP == "-i" ]];then
GET=$(curl -s ipinfo.io/`hostname -i`|egrep -v "{|}"|sed -e 's/"//g;s/,//g;s/^[ \t]*//;s/[ \t]*$//'|sed -e "s/loc:/loc: https:\/\/google.com.br\/maps?q=/g"|sed 's/= -/=-/g') && GETMAP=$(echo $GET|grep =-|cut -d- -f2,3,4,5)
INVOKEMAP=$(curl -s -H "Content-Type: application/json" --data @body.json http://maps.google.com/maps/api/geocode/json?address=-$GETMAP|grep formatted_address|head -1|awk -F: '{print $2}'|cut -d '"' -f2)
echo -e "$GET\nend: $INVOKEMAP"
exit
fi

# CALL CURL ON IPINFO
CHECKIP(){
GET=$(curl -s ipinfo.io/${IP}|egrep -v "{|}"|sed -e 's/"//g;s/,//g;s/^[ \t]*//;s/[ \t]*$//'|sed -e "s/loc:/loc: https:\/\/google.com.br\/maps?q=/g"|sed 's/= -/=-/g') && GETMAP=$(echo $GET|grep =-|cut -d- -f2,3,4,5)
INVOKEMAP=$(curl -s -H "Content-Type: application/json" --data @body.json http://maps.google.com/maps/api/geocode/json?address=-$GETMAP|grep formatted_address|head -1|awk -F: '{print $2}'|cut -d '"' -f2)
echo -e "$GET\nend: $INVOKEMAP"
}

REQUEST=$(echo "$IP"|awk '$0 ~/[^0-9.]/ { print "NOT_NUMBER" }')
#echo "Request Id: $IP"
#echo "TEST :::$REQUEST"

echo -e "\nInformation for $IP\n"
# CHECK IF RETURN IS IP OR DOMAIN
if [[ "$IP" != "" ]] && [[ "$REQUEST" != "NOT_NUMBER" ]]; then
#IF OK INVOKE CHECKIP FUNCTION
CHECKIP
else
#IF NOT CURL AND DIG A FOR DOMAIN
GET=$(curl -s ipinfo.io/`dig +short A $IP|head -1`|egrep -v "{|}"|sed -e 's/"//g;s/,//g;s/^[ \t]*//;s/[ \t]*$//'|sed -e "s/loc:/loc: https:\/\/google.com.br\/maps?q=/g"|sed 's/= -/=-/g') && GETMAP=$(echo $GET|grep =-|cut -d- -f2,3,4,5)
INVOKEMAP=$(curl -s -H "Content-Type: application/json" --data @body.json http://maps.google.com/maps/api/geocode/json?address=-$GETMAP|grep formatted_address|head -1|awk -F: '{print $2}'|cut -d '"' -f2)
echo -e "$GET\nend: $INVOKEMAP"
fi